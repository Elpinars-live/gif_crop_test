<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>GIF Cropper</title>
  <style>
    body{font-family:Arial;margin:2rem;background:#f5f5f5}
    #preview{max-width:100%;border:1px solid #ccc;background:#fff}
    #selection{position:absolute;border:2px dashed #0af;background:rgba(0,170,255,.2);
               pointer-events:none;display:none}
    .btn{background:#0af;color:#fff;border:none;padding:.5rem 1rem;margin:.5rem 0;
         cursor:pointer;border-radius:4px}
  </style>
</head>
<body>
  <h1>GIF Cropper</h1>
  <input type="file" id="fileInput" accept="image/gif">
  <br>
  <div style="position:relative;display:inline-block" id="wrapper">
    <img id="preview">
    <div id="selection"></div>
  </div>
  <br>
  <button class="btn" id="cropBtn" disabled>Recadrer & télécharger</button>
  <a id="downloadLink" style="display:none" class="btn">⬇ Télécharger</a>

<script>
const fileIn=document.getElementById('fileInput');
const preview=document.getElementById('preview');
const sel=document.getElementById('selection');
const cropBtn=document.getElementById('cropBtn');
const dl=document.getElementById('downloadLink');

let coords={x:0,y:0,w:0,h:0};

fileIn.onchange=e=>{
  const file=e.target.files[0];
  if(!file)return;
  const url=URL.createObjectURL(file);
  preview.src=url;
  preview.onload=()=>{
    sel.style.display='block';
    cropBtn.disabled=false;
  };
};

let down=false;
preview.onmousedown=e=>{
  down=true;
  const rect=preview.getBoundingClientRect();
  coords.x=e.clientX-rect.left;
  coords.y=e.clientY-rect.top;
};
preview.onmousemove=e=>{
  if(!down)return;
  const rect=preview.getBoundingClientRect();
  const x2=e.clientX-rect.left;
  const y2=e.clientY-rect.top;
  coords.w=Math.abs(x2-coords.x);
  coords.h=Math.abs(y2-coords.y);
  const l=Math.min(coords.x,x2);
  const t=Math.min(coords.y,y2);
  sel.style.left=l+'px';
  sel.style.top=t+'px';
  sel.style.width=coords.w+'px';
  sel.style.height=coords.h+'px';
};
preview.onmouseup=()=>down=false;

cropBtn.onclick=async ()=>{
  const form=new FormData();
  form.append('file',fileIn.files[0]);
  form.append('left',Math.round(coords.x));
  form.append('top',Math.round(coords.y));
  form.append('width',Math.round(coords.w));
  form.append('height',Math.round(coords.h));
  const r=await fetch('/crop',{method:'POST',body:form}).then(r=>r.json());
  dl.href=r.download_url;
  dl.style.display='inline-block';
};
</script>
</body>
</html>